<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Crypto Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; margin: 10px 0; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Manual Crypto Fix Validation Test</h1>
    
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function addResult(title, status, message, details = '') {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            results.appendChild(div);
        }

        async function runTests() {
            addResult('üöÄ Starting Tests', 'info', 'Testing crypto module compatibility fixes...');

            // Test 1: Check if crypto-related modules can be imported without error
            try {
                // This would previously fail with "Module crypto has been externalized"
                console.log('Testing crypto availability...');
                
                // Test Web Crypto API (this should work)
                if (window.crypto && window.crypto.subtle) {
                    addResult('‚úÖ Web Crypto API', 'success', 'Web Crypto API is available for client-side operations');
                } else {
                    addResult('‚ùå Web Crypto API', 'error', 'Web Crypto API not available');
                }
            } catch (error) {
                addResult('‚ùå Crypto Test', 'error', 'Error testing crypto:', error.message);
            }

            // Test 2: Verify no speakeasy/qrcode modules are being loaded
            try {
                console.log('Testing for removed Node.js modules...');
                
                // This should not be accessible anymore
                if (typeof window.require === 'undefined') {
                    addResult('‚úÖ Node.js Modules', 'success', 'Node.js modules (require) not accessible in browser - correct behavior');
                } else {
                    addResult('‚ö†Ô∏è Node.js Modules', 'error', 'Node.js require still accessible - potential issue');
                }
            } catch (error) {
                addResult('‚úÖ Node.js Modules', 'success', 'Node.js modules properly isolated from browser');
            }

            // Test 3: Test Edge Function availability
            try {
                console.log('Testing Edge Function availability...');
                
                const response = await fetch('https://hkghwdexiobvaoqkpxqj.supabase.co/functions/v1/admin-generate-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.status === 401) {
                    addResult('‚úÖ Edge Function', 'success', 
                        'admin-generate-2fa Edge Function is deployed and responding (401 = needs auth, which is correct)');
                } else if (response.status === 404) {
                    addResult('‚ùå Edge Function', 'error', 
                        'admin-generate-2fa Edge Function not found - may need deployment');
                } else {
                    addResult('‚ö†Ô∏è Edge Function', 'info', 
                        `admin-generate-2fa Edge Function responded with status: ${response.status}`);
                }
            } catch (error) {
                addResult('‚ùå Edge Function', 'error', 'Error testing Edge Function:', error.message);
            }

            // Test 4: Check for console errors related to crypto
            setTimeout(() => {
                const consoleErrors = [];
                const originalError = console.error;
                console.error = function(...args) {
                    consoleErrors.push(args.join(' '));
                    originalError.apply(console, args);
                };

                // Simulate what would happen when 2FA page loads
                try {
                    // This would previously cause "Module crypto has been externalized" error
                    console.log('Simulating 2FA page load...');
                    
                    const cryptoErrors = consoleErrors.filter(error => 
                        error.includes('crypto') || 
                        error.includes('speakeasy') || 
                        error.includes('qrcode') ||
                        error.includes('externalized')
                    );

                    if (cryptoErrors.length === 0) {
                        addResult('‚úÖ Console Errors', 'success', 'No crypto-related console errors detected');
                    } else {
                        addResult('‚ùå Console Errors', 'error', 
                            'Crypto-related console errors found:', cryptoErrors.join('\\n'));
                    }
                } catch (error) {
                    addResult('‚ùå Console Test', 'error', 'Error during console test:', error.message);
                }

                console.error = originalError;
                
                addResult('üéØ Test Complete', 'info', 
                    'Manual validation complete. Check results above for crypto fix status.');
            }, 1000);
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>
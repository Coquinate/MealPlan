# Story 1.6: Deployment Pipeline & Health Check

## Status

Draft

## Story

**As a** developer,
**I want** simple deployment to Vercel with basic health checks,
**so that** code deploys reliably to production.

## Acceptance Criteria

1. Vercel connected to GitHub repo (auto-deploy on push to main)
2. Environment variables configured in Vercel dashboard
3. /api/health endpoint that checks database connection
4. Build command runs type-check and lint
5. Simple deployment notification (Discord webhook or email)
6. One-click rollback available in Vercel dashboard

## Tasks / Subtasks

- [ ] Set up Vercel project configuration (AC: 1, 2)
  - [ ] Connect GitHub repository to Vercel
  - [ ] Configure build settings and framework preset for Next.js
  - [ ] Set up environment variables in Vercel dashboard
  - [ ] Configure production domain settings
  - [ ] Enable automatic deployments from main branch
  - [ ] Configure preview deployments for pull requests

- [ ] Configure environment variables and secrets (AC: 2)
  - [ ] Create comprehensive .env.example file with all required variables
  - [ ] Add production environment variables to Vercel dashboard
  - [ ] Configure Supabase connection strings (DATABASE_URL, SUPABASE_URL, SUPABASE_ANON_KEY)
  - [ ] Add authentication secrets (SUPABASE_SERVICE_ROLE_KEY, JWT_SECRET)
  - [ ] Configure external API keys (GEMINI_API_KEY, RESEND_API_KEY, STRIPE_SECRET_KEY)
  - [ ] Set up deployment-specific variables (VERCEL_URL, NEXT_PUBLIC_SITE_URL)

- [ ] Implement health check endpoint (AC: 3)
  - [ ] Create /api/health route handler in apps/web/src/pages/api/health.ts
  - [ ] Implement database connectivity check using Supabase client
  - [ ] Add response time measurement for database query
  - [ ] Include version information from package.json
  - [ ] Return standardized health check response format
  - [ ] Add error handling for database connection failures

- [ ] Configure build pipeline and validation (AC: 4)
  - [ ] Update package.json build script to include type-check and lint
  - [ ] Create turbo.json for optimized monorepo builds
  - [ ] Configure ESLint for production build validation
  - [ ] Set up TypeScript strict mode checking in build
  - [ ] Add pre-build validation script
  - [ ] Configure build error reporting

- [ ] Set up deployment notifications (AC: 5)
  - [ ] Create Discord webhook or configure email notification
  - [ ] Implement deployment notification Edge Function
  - [ ] Configure Vercel deployment hooks
  - [ ] Add deployment status tracking
  - [ ] Include build time and commit info in notifications
  - [ ] Test notification delivery

- [ ] Configure Vercel deployment settings (AC: 6)
  - [ ] Enable instant rollback in Vercel dashboard
  - [ ] Configure production branch protection
  - [ ] Set up deployment protection rules
  - [ ] Configure build cache settings
  - [ ] Enable Vercel Analytics (free tier)
  - [ ] Set up error monitoring integration

- [ ] Create GitHub Actions CI workflow (AC: 4)
  - [ ] Create .github/workflows/ci.yaml for PR validation
  - [ ] Configure pnpm setup and caching
  - [ ] Add type checking step
  - [ ] Add linting step
  - [ ] Add unit test execution
  - [ ] Configure status checks for PR merging

- [ ] Validate deployment pipeline end-to-end (AC: 1-6)
  - [ ] Test auto-deployment on push to main
  - [ ] Verify health check endpoint in production
  - [ ] Test deployment notifications
  - [ ] Validate rollback functionality
  - [ ] Confirm environment variables are properly loaded
  - [ ] Test preview deployments on PR

## Dev Notes

### Previous Story Insights

[From Story 1.5 - Authentication System]

- Supabase project "Coquinate" already configured (id: xsogkcvmdrhnbazstpxqj)
- Environment variables structure partially defined in .env files
- Type safety issues found that should be caught by build validation
- Testing infrastructure partially in place with Vitest and Playwright
- Edge Functions deployment pattern established via Supabase CLI

### Technology Stack Requirements

[Source: architecture/tech-stack.md]

- **CI/CD**: GitHub Actions for automation with native GitHub integration
- **Build Tool**: Vite 7.0.x for frontend bundling (5x faster builds)
- **Package Manager**: pnpm 10.14.0 for dependency management
- **Testing**: Vitest 3.2.x for unit tests, Playwright 1.54.0 for E2E
- **Monitoring**: Vercel Analytics for performance metrics (Core Web Vitals)
- **Logging**: Supabase Logs for application logs (platform integrated)
- **Linter**: ESLint 9.33.x with flat config and TypeScript support
- **Formatter**: Prettier 3.4.x for consistent code formatting
- **Node.js**: Version 20.x or 22.x required (18.x EOL'd April 2025)

### Deployment Architecture

[Source: architecture/deployment.md]
**Frontend (Vercel):**

- Connect GitHub repo to Vercel
- Auto-deploy on push to main branch
- Preview deployments on PRs
- Environment variables in Vercel Dashboard

**Backend (Supabase):**

- Edge Functions deployed via Supabase CLI when needed
- Database migrations via Supabase Dashboard
- Environment variables in Supabase Dashboard

### Project Structure Requirements

[Source: architecture/unified-project-structure.md]

```
Key file locations for this story:
.github/
└── workflows/
    ├── ci.yaml              # Test and lint on PR (CREATE)
    └── deploy.yaml          # Deploy to Vercel/Supabase (CREATE)

apps/web/
├── src/
│   └── pages/
│       └── api/
│           └── health.ts    # Health check endpoint (CREATE)
├── package.json             # Build scripts (MODIFY)
└── vercel.json             # Vercel configuration (CREATE)

supabase/functions/
└── deployment-notify/       # Deployment notification (CREATE)
    └── index.ts

scripts/
├── validate-build.sh        # Build validation script (CREATE)
└── deploy.sh               # Deployment helper (CREATE)

/
├── .env.example            # Environment template (CREATE/UPDATE)
├── turbo.json              # Turborepo config (CREATE)
└── package.json            # Root scripts (MODIFY)
```

### Environment Variables Required

[Source: Multiple architecture files]

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
DATABASE_URL=

# Authentication
JWT_SECRET=
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# External Services
GEMINI_API_KEY=
RESEND_API_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=

# Deployment
VERCEL_URL=
NEXT_PUBLIC_SITE_URL=
DEPLOYMENT_WEBHOOK_URL=  # Discord or email webhook

# Feature Flags
MAINTENANCE_MODE=false
```

### Build Configuration Requirements

[Source: architecture/tech-stack.md, coding-standards.md]
**Build Script Requirements:**

```json
{
  "scripts": {
    "build": "turbo run build",
    "type-check": "tsc --noEmit",
    "lint": "eslint . --max-warnings 0",
    "validate": "pnpm run type-check && pnpm run lint",
    "deploy": "pnpm run validate && pnpm run build"
  }
}
```

**TypeScript Configuration:**

- Strict mode enabled
- No `any` types allowed
- Path aliases configured
- Target ES2022 or later

**ESLint Configuration:**

- Flat config format (v9.33.x)
- No hardcoded strings rule
- No arbitrary Tailwind values
- Import order enforcement

### Health Check Endpoint Specification

[Source: Based on monitoring requirements]

```typescript
// apps/web/src/pages/api/health.ts
interface HealthCheckResponse {
  status: 'healthy' | 'degraded' | 'unhealthy';
  version: string;
  timestamp: string;
  checks: {
    database: {
      status: 'up' | 'down';
      responseTime: number;
    };
    supabase: {
      status: 'up' | 'down';
    };
  };
  environment: 'production' | 'preview' | 'development';
}
```

### GitHub Actions CI Configuration

[Source: Based on deployment requirements]

```yaml
# .github/workflows/ci.yaml structure
name: CI
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - Checkout code
      - Setup pnpm
      - Install dependencies
      - Run type-check
      - Run lint
      - Run tests
      - Build project
```

### Vercel Configuration Requirements

[Source: architecture/deployment.md]
**vercel.json:**

```json
{
  "framework": "nextjs",
  "buildCommand": "pnpm run deploy",
  "installCommand": "pnpm install",
  "outputDirectory": "apps/web/.next",
  "ignoreCommand": "git diff HEAD^ HEAD --quiet ."
}
```

### Deployment Notification Requirements

- Simple webhook integration (Discord or email via Resend)
- Include: deployment status, commit SHA, commit message, deploy URL
- Trigger on: successful deployment, failed deployment, rollback
- No complex monitoring or metrics collection

### Monitoring Configuration

[Source: architecture/monitoring.md]
**Minimal Monitoring Setup:**

- Vercel Analytics (free tier) - basic page views only
- Vercel's built-in error tracking
- Supabase Dashboard for database monitoring
- Track: Page views, Web Vitals, Production errors (automatic)
- NO custom metrics, complex dashboards, or third-party services

### Security Considerations for Deployment

[Source: architecture/security-and-performance.md]

- Environment variables must never be committed to repository
- Use Vercel's secret management for sensitive values
- Enable HTTPS only (automatic with Vercel)
- Configure CSP headers in Next.js
- Set up rate limiting for API routes
- Enable Vercel DDoS protection (automatic)

### Critical Implementation Notes

- Vercel free tier supports automatic deployments and rollbacks
- GitHub integration provides automatic PR previews
- Build caching reduces deployment time significantly
- Environment variables are encrypted at rest in Vercel
- Health check should not expose sensitive information
- Deployment notifications should be idempotent

### Testing Requirements for This Story

[Source: architecture/testing-strategy.md]

- Deployment pipeline must be tested end-to-end
- Health check endpoint requires unit tests
- CI workflow must validate on test PR
- Rollback functionality must be manually tested
- Environment variable loading must be verified

## Testing

### Testing Requirements for This Story

[Source: architecture/testing-strategy.md]

- **CI/CD Pipeline**: Must successfully validate all PRs
- **Health Check**: Unit tests for endpoint logic
- **Build Validation**: Ensure type-check and lint catch issues
- **Deployment**: Manual testing of auto-deploy and rollback

### Test File Locations

- **Health Check Tests**: `apps/web/tests/api/health.test.ts`
- **Build Scripts Tests**: `scripts/tests/validate-build.test.sh`
- **CI Workflow Tests**: Manual validation via test PR

### Specific Test Requirements

- Health endpoint returns correct status codes
- Database connectivity check handles failures gracefully
- Build fails on TypeScript errors
- Build fails on ESLint violations
- Deployment notifications are delivered
- Rollback restores previous working version

## Dev Agent Record

### Agent Model Used

[To be filled by Dev Agent]

### Debug Log References

[To be filled by Dev Agent]

### Completion Notes

[To be filled by Dev Agent]

### File List

[To be filled by Dev Agent]

## QA Results

[To be filled by QA Agent]

## Change Log

| Date       | Version | Description                                                 | Author             |
| ---------- | ------- | ----------------------------------------------------------- | ------------------ |
| 2025-08-12 | 1.0     | Initial story creation with comprehensive technical context | Bob (Scrum Master) |
